<div class="container animate-fade">
    <div class="page-title-section">
        <div>
            <h1 class="title-font">Gerenciamento de Reservas</h1>
            <p>Controle empréstimos, devoluções e multas.</p>
        </div>
        <a routerLink="/reservas/nova" class="btn-premium btn-premium-primary">
            <lucide-icon [img]="PlusIcon" [size]="20"></lucide-icon>
            Nova Reserva
        </a>
    </div>

    <div class="card-premium no-padding overflow-hidden">
        <div class="table-actions">
            <div class="filter-tabs">
                <button class="tab" [class.active]="currentFilter === 'todas'"
                    (click)="setFilter('todas')">Todas</button>
                <button class="tab" [class.active]="currentFilter === 'ativa'"
                    (click)="setFilter('ativa')">Ativas</button>
                <button class="tab" [class.active]="currentFilter === 'atrasada'"
                    (click)="setFilter('atrasada')">Atrasadas</button>
                <button class="tab" [class.active]="currentFilter === 'concluida'"
                    (click)="setFilter('concluida')">Concluídas</button>
            </div>
        </div>

        <div *ngIf="loading && reservas.length === 0" class="loading-state">Carregando...</div>

        <div *ngIf="error" class="error-msg text-center p-4">{{ error }}</div>

        <!-- Desktop Table View -->
        <table *ngIf="!error && reservas.length > 0" class="table-premium hidden-mobile" [class.is-reloading]="loading">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Cliente / Livro</th>
                    <th>Datas</th>
                    <th>Status</th>
                    <th>Multa</th>
                    <th class="text-right">Ações</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let reserva of reservas; let idx = index">
                    <td class="index-col">{{ idx + 1 }}</td>
                    <td>
                        <div class="reserva-main-info">
                            <span class="book-title">{{ getLivroTitulo(reserva) }}</span>
                            <span class="client-name">{{ getClienteNome(reserva) }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="reserva-dates">
                            <span class="date-row">Reserva: {{ formatDateLocal(reserva.dataReserva) }}</span>
                            <span class="date-row highlight" [class.overdue]="reserva.status === 'atrasada'">
                                Prevista: {{ formatDate(reserva.dataPrevistaDevolucao) }}
                            </span>
                        </div>
                    </td>
                    <td>
                        <span class="badge-premium" [ngClass]="'badge-' + reserva.status">
                            {{ reserva.status }}
                        </span>
                    </td>
                    <td>
                        <div *ngIf="reserva.multa" class="multa-info">
                            <span class="valor">{{ formatCurrency(reserva.multa.valorTotal) }}</span>
                            <span class="dias">{{ reserva.multa.diasAtraso }} dias de atraso</span>
                        </div>
                        <span *ngIf="!reserva.multa" class="no-multa">R$ 0,00</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button *ngIf="reserva.status !== 'concluida'" class="btn-concluir"
                                (click)="confirmDevolucao(reserva)">
                                <lucide-icon [img]="CheckCircleIcon" [size]="16"></lucide-icon>
                                Concluir
                            </button>
                            <button class="btn-icon-only text-slate-300 hover:text-rose-500"
                                (click)="confirmDelete(reserva)">
                                <lucide-icon [img]="Trash2Icon" [size]="18"></lucide-icon>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Mobile Card View -->
        <div *ngIf="!error && reservas.length > 0" class="mobile-reserva-list hidden-desktop"
            [class.is-reloading]="loading">
            <div *ngFor="let reserva of reservas" class="reserva-mobile-card">
                <div class="card-status-dot" [ngClass]="'status-' + reserva.status"></div>
                <div class="reserva-header">
                    <div class="book-info">
                        <span class="book-title">{{ getLivroTitulo(reserva) }}</span>
                        <span class="client-name">{{ getClienteNome(reserva) }}</span>
                    </div>
                    <span class="badge-premium" [ngClass]="'badge-' + reserva.status">
                        {{ reserva.status === 'atrasada' ? 'Atrasada' : (reserva.status === 'ativa' ? 'Ativa' :
                        'Concluída') }}
                    </span>
                </div>

                <div class="reserva-details">
                    <div class="detail-row">
                        <lucide-icon [img]="CalendarIcon" [size]="14"></lucide-icon>
                        <span>Reserva: {{ formatDateLocal(reserva.dataReserva) }}</span>
                    </div>
                    <div class="detail-row" [class.overdue]="reserva.status === 'atrasada'">
                        <lucide-icon [img]="ClockIcon" [size]="14"></lucide-icon>
                        <span>Prevista: {{ formatDate(reserva.dataPrevistaDevolucao) }}</span>
                    </div>
                </div>

                <div *ngIf="reserva.multa" class="mobile-multa-info">
                    <span class="multa-label">MULTA ACUMULADA</span>
                    <span class="multa-value">{{ formatCurrency(reserva.multa.valorTotal) }} ({{
                        reserva.multa.diasAtraso }}d)</span>
                </div>

                <div class="reserva-actions">
                    <button *ngIf="reserva.status !== 'concluida'" class="btn-premium btn-premium-primary full-width"
                        (click)="confirmDevolucao(reserva)">
                        <lucide-icon [img]="CheckCircleIcon" [size]="18"></lucide-icon>
                        Concluir Devolução
                    </button>
                    <button class="btn-premium btn-premium-secondary full-width" (click)="confirmDelete(reserva)">
                        <lucide-icon [img]="Trash2Icon" [size]="18"></lucide-icon>
                        Excluir Registro
                    </button>
                </div>
            </div>
        </div>

        <div *ngIf="!loading && !error && reservas.length === 0" class="empty-reservas">
            Nenhuma reserva encontrada.
        </div>
        <!-- Pagination -->
        <div *ngIf="!loading && !error && totalItems > 0" class="pagination-footer">
            <div class="pagination-info">
                Mostrando {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalItems) }} de
                {{ totalItems }} registros
            </div>
            <div class="pagination-actions">
                <button [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)" class="btn-page">
                    <lucide-icon [img]="ChevronLeftIcon" [size]="18"></lucide-icon>
                    Anterior
                </button>
                <span class="current-page">{{ currentPage }}</span>
                <button [disabled]="currentPage * pageSize >= totalItems" (click)="changePage(currentPage + 1)"
                    class="btn-page">
                    Próximo
                    <lucide-icon [img]="ChevronRightIcon" [size]="18"></lucide-icon>
                </button>
            </div>
        </div>
    </div>

    <app-confirmation-modal [isOpen]="modalOpen" [title]="modalConfig.title" [message]="modalConfig.message"
        [confirmText]="modalConfig.confirmText" [cancelText]="modalConfig.cancelText" [type]="modalConfig.type"
        (confirm)="onModalConfirm()" (cancel)="onModalCancel()">
    </app-confirmation-modal>